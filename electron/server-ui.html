<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PigeonFS Node Server Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #1a1a1a;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header svg {
            width: 60px;
            height: 60px;
            margin-right: 20px;
        }

        h1 {
            font-size: 32px;
            margin: 0;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            margin-bottom: 15px;
            font-size: 20px;
            color: #1a1a1a;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .status-label {
            font-size: 12px;
            opacity: 0.6;
            margin-bottom: 5px;
            color: #666;
        }

        .status-value {
            font-size: 20px;
            font-weight: bold;
            color: #1a1a1a;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-indicator.running {
            background: #4ade80;
            box-shadow: 0 0 10px #4ade80;
        }

        .status-indicator.stopped {
            background: #ef4444;
        }

        button {
            background: #1a1a1a;
            border: 1px solid #1a1a1a;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            margin-right: 10px;
        }

        button:hover {
            background: #333;
            border-color: #333;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.primary {
            background: #4ade80;
            border-color: #4ade80;
            color: #1a1a1a;
        }

        button.primary:hover {
            background: #22c55e;
            border-color: #22c55e;
        }

        button.danger {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
        }

        button.danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .logs {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #333;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.error {
            color: #ef4444;
        }

        .log-entry.info {
            color: #333;
        }

        .files-list {
            list-style: none;
        }

        .file-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #1a1a1a;
        }

        .file-meta {
            font-size: 12px;
            opacity: 0.7;
            color: #666;
        }

        .file-actions button {
            padding: 8px 16px;
            font-size: 12px;
            margin-left: 8px;
        }

        .upload-form {
            margin-bottom: 20px;
        }

        input[type="file"] {
            display: none;
        }

        .file-upload-btn {
            display: inline-block;
            background: #f9f9f9;
            border: 2px dashed #ccc;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 10px;
            color: #666;
        }

        .file-upload-btn:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        .selected-file {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            color: #333;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            color: #1a1a1a;
            font-size: 14px;
            margin-bottom: 10px;
        }

        input[type="text"]::placeholder {
            color: #999;
        }

        .config-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <svg version="1.1" id="Layer_1" x="0px" y="0px" width="100%" viewBox="0 0 400 400" enable-background="new 0 0 400 400" xml:space="preserve">
                <g id="g1" style="fill:#1a1a1a">
                    <path fill="#000000" opacity="1.000000" stroke="none" d=" M120.468147,21.381325   C150.957001,7.007360 182.981934,2.511711 215.769806,4.990532   C264.741272,8.692862 307.189270,27.724031 341.749084,63.034561   C371.673706,93.609230 390.084351,129.914551 395.508698,172.659744   C400.219971,209.785522 396.896851,245.893478 381.415894,280.148102   C359.249359,329.195953 323.539032,364.613953 273.029633,384.369141   C248.739410,393.869568 223.576569,399.261566 197.418854,398.134613   C129.008820,395.187317 74.925789,365.637848 36.818604,308.706299   C19.690449,283.117065 9.356023,254.531311 6.509281,223.433182   C0.360511,156.263382 21.346617,99.472046 70.926376,53.611313   C85.437164,40.188988 101.969215,29.535603 120.468147,21.381325  M270.387939,108.192596   C275.618103,117.372398 279.516052,127.079475 281.337250,137.501389   C282.081421,141.759766 284.215179,144.517975 287.657196,147.061478   C304.841034,159.759628 321.036224,173.620041 335.232330,189.657059   C341.298767,196.510147 347.458191,203.404449 349.494049,212.773529   C350.531921,217.549881 348.457794,219.830002 343.695984,219.141724   C342.056458,218.904755 340.458221,218.381500 338.841492,217.987427   C319.818604,213.350662 300.455200,210.393539 280.983795,212.447937   C252.188278,215.486099 242.250076,231.618851 242.618347,257.128632   C242.830902,271.852905 247.283859,285.860596 252.465714,299.661438   C259.429108,318.207214 265.145691,337.132721 267.592407,356.939240   C268.054932,360.683441 267.341187,364.986176 270.126678,368.296021   C317.061981,351.057007 380.640472,291.725525 381.418518,201.259262   C382.126129,118.984360 326.737000,47.228451 247.962952,26.676783   C164.460785,4.891574 82.985291,41.991894 42.807281,114.625771   C9.980222,173.970566 20.332239,252.160095 41.899414,281.980133   C46.056343,276.605194 48.612194,270.544464 50.950127,264.290161   C58.917362,242.976685 62.716553,220.696869 66.730515,198.441345   C70.801041,175.872192 74.669456,153.279358 83.538956,131.858078   C100.847382,90.055397 140.921997,56.608147 193.015991,60.710079   C226.376907,63.336948 252.460632,78.618561 270.387939,108.192596  M75.957253,296.457520   C69.154053,296.298950 62.318226,295.387573 55.583069,297.069519   C50.880104,298.243958 50.315563,299.537689 53.062222,303.583221   C57.925316,310.746033 63.141083,317.649292 69.137230,323.929108   C91.349602,347.192261 116.816727,365.339447 148.279907,373.897461   C153.747467,375.384613 159.292816,377.335754 165.236130,376.342041   C160.386276,343.455292 121.047539,305.242371 75.957253,296.457520  M170.878464,171.725739   C182.350723,175.779358 192.971878,174.071259 202.157852,166.185440   C211.449387,158.208984 215.138840,147.898987 212.612289,135.748596   C208.134933,114.216660 181.203903,104.033890 163.665161,117.167091   C143.958481,131.923676 147.376968,160.484970 170.878464,171.725739  M293.165527,171.349884   C288.533569,167.822983 283.781067,164.469177 278.666992,161.673325   C276.790985,160.647690 274.883545,159.587173 272.576813,159.852905   C263.079193,160.946991 251.725357,173.430832 251.251633,182.916107   C251.040131,187.151199 252.349136,188.759674 256.752319,188.984711   C273.992737,189.865799 291.165741,191.448608 307.974518,195.735489   C312.184998,196.809326 316.339264,198.345230 321.791504,198.288239   C312.766602,188.193207 303.602844,179.623199 293.165527,171.349884  z" id="path1" style="fill:#1a1a1a" />
                    <path fill="#000000" opacity="1.000000" stroke="none" d=" M164.621384,142.091873   C165.557266,130.660858 172.520447,124.145866 182.761856,124.686325   C192.462006,125.198235 200.468567,133.709045 200.133820,143.152374   C199.780228,153.126877 192.241592,160.504852 182.440079,160.468979   C171.919250,160.430496 164.941574,153.415634 164.621384,142.091873  z" id="path2" style="fill:#1a1a1a" />
                </g>
            </svg>
            <div>
                <h1>PigeonFS Node Server Manager</h1>
                <div style="opacity: 0.6;">Manage your distributed file system node</div>
            </div>
        </div>

        <!-- Server Status -->
        <div class="card">
            <h2>Server Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Status</div>
                    <div class="status-value">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="serverStatus">Stopped</span>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-label">Port</div>
                    <div class="status-value" id="serverPort">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Files Hosted</div>
                    <div class="status-value" id="filesCount">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Data Directory</div>
                    <div class="status-value" id="dataDir" style="font-size: 12px;">Not set</div>
                </div>
            </div>
            <div>
                <button class="primary" id="startBtn" onclick="startServer()">‚ñ∂ Start Server</button>
                <button class="danger" id="stopBtn" onclick="stopServer()" disabled>‚èπ Stop Server</button>
                <button onclick="selectDataDir()">üìÅ Select Data Directory</button>
                <button onclick="refreshFiles()">üîÑ Refresh</button>
            </div>
        </div>

        <!-- Server Configuration -->
        <div class="card">
            <h2>Server Configuration</h2>
            <div class="config-form">
                <div class="form-group">
                    <label>Signaling Server URL</label>
                    <input type="text" id="signalingUrl" placeholder="ws://localhost:3001" value="ws://localhost:3001">
                </div>
                <div class="form-group">
                    <label>HTTP Port (0 for auto)</label>
                    <input type="text" id="httpPort" placeholder="3000" value="0">
                </div>
            </div>
        </div>

        <!-- File Upload -->
        <div class="card">
            <h2>Upload Files</h2>
            <div class="upload-form">
                <label for="fileInput" class="file-upload-btn">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì§</div>
                    <div>Click to select file or drag and drop</div>
                </label>
                <input type="file" id="fileInput" onchange="handleFileSelect(event)">
                <div id="selectedFile" style="display: none;" class="selected-file">
                    <strong>Selected:</strong> <span id="fileName"></span>
                </div>
                <button class="primary" id="uploadBtn" onclick="uploadFile()" disabled>Upload to Server</button>
            </div>
        </div>

        <!-- Files List -->
        <div class="card">
            <h2>Hosted Files</h2>
            <ul class="files-list" id="filesList">
                <li class="empty-state">No files hosted yet</li>
            </ul>
        </div>

        <!-- Server Logs -->
        <div class="card">
            <h2>Server Logs</h2>
            <div class="logs" id="logs">
                <div class="log-entry">Server not started...</div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let serverRunning = false;

        // Listen for server logs
        window.electronAPI.onServerLog((log) => {
            addLog(log, 'info');
        });

        window.electronAPI.onServerError((error) => {
            addLog(error, 'error');
        });

        window.electronAPI.onServerStarted((config) => {
            serverRunning = true;
            updateUI();
            document.getElementById('serverPort').textContent = config.httpPort;
            addLog(`Server started on port ${config.httpPort}`, 'info');
            refreshFiles();
        });

        window.electronAPI.onServerStopped(() => {
            serverRunning = false;
            updateUI();
            addLog('Server stopped', 'info');
        });

        async function startServer() {
            const signalingUrl = document.getElementById('signalingUrl').value;
            const httpPort = parseInt(document.getElementById('httpPort').value) || 0;
            
            addLog('Starting server...', 'info');
            const result = await window.electronAPI.startServer({ signalingUrl, httpPort });
            
            if (!result.success) {
                addLog(`Failed to start: ${result.error}`, 'error');
            }
        }

        async function stopServer() {
            addLog('Stopping server...', 'info');
            await window.electronAPI.stopServer();
        }

        async function selectDataDir() {
            const dir = await window.electronAPI.selectDirectory();
            if (dir) {
                document.getElementById('dataDir').textContent = dir;
                addLog(`Data directory set to: ${dir}`, 'info');
            }
        }

        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                document.getElementById('selectedFile').style.display = 'block';
                document.getElementById('fileName').textContent = selectedFile.name;
                document.getElementById('uploadBtn').disabled = !serverRunning;
            }
        }

        async function uploadFile() {
            if (!selectedFile || !serverRunning) return;

            try {
                addLog(`Uploading ${selectedFile.name}...`, 'info');
                
                // Read file as ArrayBuffer
                const arrayBuffer = await selectedFile.arrayBuffer();
                const buffer = Array.from(new Uint8Array(arrayBuffer));
                
                // Upload via IPC (writes directly to files directory)
                const result = await window.electronAPI.uploadFile({
                    fileName: selectedFile.name,
                    fileBuffer: buffer
                });

                if (result.success) {
                    addLog(`Upload successful! File saved to: ${result.filePath}`, 'info');
                    selectedFile = null;
                    document.getElementById('fileInput').value = '';
                    document.getElementById('selectedFile').style.display = 'none';
                    document.getElementById('uploadBtn').disabled = true;
                    
                    // Wait a bit for server to detect the file, then refresh
                    setTimeout(refreshFiles, 1000);
                } else {
                    addLog(`Upload failed: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`Upload error: ${error.message}`, 'error');
            }
        }

        async function refreshFiles() {
            if (!serverRunning) return;

            const port = document.getElementById('serverPort').textContent;
            try {
                const response = await fetch(`http://localhost:${port}/files`);
                const files = await response.json();
                
                const filesList = document.getElementById('filesList');
                document.getElementById('filesCount').textContent = files.length;

                if (files.length === 0) {
                    filesList.innerHTML = '<li class="empty-state">No files hosted yet</li>';
                } else {
                    filesList.innerHTML = files.map(file => `
                        <li class="file-item">
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-meta">
                                    ID: ${file.id} | Size: ${formatBytes(file.size)}
                                </div>
                            </div>
                            <div class="file-actions">
                                <button onclick="downloadFile('${file.id}', '${file.name}')">‚¨á Download</button>
                                <button onclick="copyUrl('${file.id}')">üîó Copy URL</button>
                            </div>
                        </li>
                    `).join('');
                }
            } catch (error) {
                addLog(`Failed to fetch files: ${error.message}`, 'error');
            }
        }

        async function downloadFile(id, name) {
            const port = document.getElementById('serverPort').textContent;
            const url = `http://localhost:${port}/files/${id}`;
            
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                addLog(`Downloaded: ${name}`, 'info');
            } catch (error) {
                addLog(`Download failed: ${error.message}`, 'error');
            }
        }

        function copyUrl(id) {
            const port = document.getElementById('serverPort').textContent;
            const url = `http://localhost:${port}/files/${id}`;
            navigator.clipboard.writeText(url);
            addLog(`URL copied: ${url}`, 'info');
        }

        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        function updateUI() {
            const indicator = document.getElementById('statusIndicator');
            const status = document.getElementById('serverStatus');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const uploadBtn = document.getElementById('uploadBtn');

            if (serverRunning) {
                indicator.classList.add('running');
                indicator.classList.remove('stopped');
                status.textContent = 'Running';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                uploadBtn.disabled = !selectedFile;
            } else {
                indicator.classList.add('stopped');
                indicator.classList.remove('running');
                status.textContent = 'Stopped';
                startBtn.disabled = false;
                stopBtn.disabled = true;
                uploadBtn.disabled = true;
                document.getElementById('serverPort').textContent = '-';
                document.getElementById('filesCount').textContent = '0';
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        // Initial UI update
        updateUI();
    </script>
</body>
</html>
